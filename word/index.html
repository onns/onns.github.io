<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Word</title>
    <link
            href="//onns.xyz/css/normalize.css"
            rel="stylesheet"
            type="text/css"
    />
    <link href="css/sheets-of-paper-a4.css" rel="stylesheet" type="text/css"/>
    <!--[if IE]>
    <script src="http://libs.useso.com/js/html5shiv/3.7/html5shiv.min.js"></script>
    <![endif]-->
    <style type="text/css">
        .btn {
            position: fixed;
        }

        input {
            margin: 50px;
            width: 200px;
            height: 40px;
            display: block;
            position: relative;
            background: #56c5ff;
            text-transform: uppercase;
            text-align: center;
            color: #ffffff;
            font-weight: 700;
            letter-spacing: 1px;
            border: none;
            font-size: 15px;
            outline: none;
        }

        button {
            margin: 50px;
            width: 200px;
            height: 80px;
            display: block;
            position: relative;
            background: #56c5ff;
            text-transform: uppercase;
            color: #ffffff;
            font-weight: 700;
            letter-spacing: 1px;
            border: none;
            font-size: 15px;
            outline: none;
        }
    </style>
</head>

<body>
<div class="document" id="document">
    <div class="btn">
        <button id="btn1">转换</button>
        <input id="ipt1" name="rate" type="text" value="60"/>
        <button id="btn2">筛选</button>
    </div>
    <div class="page" contenteditable="true"></div>
</div>
<script src="js/csvtojson.min.js"></script>
<script type="text/javascript">
    document.getElementById("btn1").onclick = function () {
        var content = document.getElementsByClassName("page")[0];
        temp = content.innerText
            .replace(/\n/g, "-enter-")
            .replace(/\s/g, "")
            .replace(/:/g, "：")
            .replace(/\(/g, "（")
            .replace(/\)/g, "）")
            .replace(/-enter-/g, " ");
        lectureList = temp.match(
            /《(人文大讲堂)·([\S]+)》([\S]+)([\s]+)([\S]+)（([\S]+)）([\s]+)主讲：([\S]+[^助理副])(助理教授|副教授|教授)([\s]+)([\S]+)([\s]+)主持人：([\S]+[^助理副])(助理教授|副教授|教授)([\s]+)时间：([\S]+)（([\S]+)）([\S]+)-([\S]+)([\s]+)地点：([\S]+)/g
        );

        lectureData = Array(lectureList.length);
        for (var i = 0; i < lectureList.length; i++) {
            lectureData[i] = Array();
            // console.log(/《(人文大讲堂)·([\S]+)》([\S]+)([\s]+)([\S]+)（([\S]+)）([\s]+)主讲:([\S]+)(教授|副教授|助理教授)([\s]+)([\S]+)([\s]+)主持人:([\S]+)(教授|副教授|助理教授)([\s]+)时间:([\S]+)（([\S]+)）([\S]+)-([\S]+)([\s]+)地点:([\S]+)/.exec(lectureList[i]));
            lectureTemp = /《(人文大讲堂)·([\S]+)》([\S]+)([\s]+)([\S]+)（([\S]+)）([\s]+)主讲：([\S]+[^助理副])(助理教授|副教授|教授)([\s]+)([\S]+)([\s]+)主持人：([\S]+[^助理副])(助理教授|副教授|教授)([\s]+)时间：([\S]+)（([\S]+)）([\S]+)-([\S]+)([\s]+)地点：([\S]+)/.exec(
                lectureList[i]
            );

            for (var j = 1; j < lectureTemp.length; j++) {
                if (lectureTemp[j].trim() != "") {
                    lectureData[i].push(lectureTemp[j]);
                }
            }
        }
        content.innerHTML =
            "var lecture_data = " + JSON.stringify(lectureData) + ";</br>";
        content.innerHTML += `
            if (app.documents.length == 2) {
                var led_index = 0;
                var post_index = 1;

                app.activeDocument = app.documents[led_index];
                var doc = app.activeDocument;
                for (var i = 0; i < doc.layerSets.length; i++) {
                    if (doc.layerSets[i].name == "模板") {
                        for (var j = 0; j < lecture_data.length; j++) {
                            var temp = doc.layerSets[i].duplicate();
                            temp.name = lecture_data[j][1];
                            temp.layers[0].textItem.contents = lecture_data[j][1];
                            temp.layers[1].textItem.contents = lecture_data[j][2] + "（" + lecture_data[j][4] + "）";
                            temp.layers[2].textItem.contents = lecture_data[j][3];
                            temp.layers[3].textItem.contents = "主讲："
                                + lecture_data[j][5] + " "
                                + lecture_data[j][6] + "\\r\\r\\r\\r主持人："
                                + lecture_data[j][8] + " "
                                + lecture_data[j][9] + "\\r时间："
                                + lecture_data[j][10] + "（"
                                + lecture_data[j][11] + "） "
                                + lecture_data[j][12] + " - "
                                + lecture_data[j][13] + "\\r地点："
                                + lecture_data[j][14];
                            temp.layers[4].textItem.contents = lecture_data[j][7];
                        }
                        break;
                    }
                }

                var color = new RGBColor();
                color.hexValue = "000000";
                app.activeDocument = app.documents[post_index];
                var doc = app.activeDocument;
                for (var i = 0; i < doc.layerSets.length; i++) {
                    if (doc.layerSets[i].name == "标题") {
                        doc.layerSets[i].layers[0].textItem.contents = lecture_data[0][4].replace("讲", "") + "-" + lecture_data[lecture_data.length - 1][4].replace("总第", "");
                        doc.layerSets[i].layers[0].textItem.color.rgb = color;
                        doc.layerSets[i].layers[0].textItem.size = 55.46;
                    }
                    if (doc.layerSets[i].name == (lecture_data.length + "门课")) {
                        for (var j = 0; j < lecture_data.length; j++) {
                            doc.layerSets[i].layers[j * 4 + lecture_data.length].textItem.contents = lecture_data[j][1];
                            doc.layerSets[i].layers[j * 4 + lecture_data.length].textItem.color.rgb = color;
                            doc.layerSets[i].layers[j * 4 + lecture_data.length].textItem.size = 55.46;

                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 1].textItem.contents = lecture_data[j][5];
                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 1].textItem.color.rgb = color;
                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 1].textItem.size = 55.52;

                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 2].textItem.contents = lecture_data[j][10];
                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 2].textItem.color.rgb = color;
                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 2].textItem.size = 55.52;

                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 3].textItem.contents = lecture_data[j][3];
                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 3].textItem.color.rgb = color;
                            doc.layerSets[i].layers[j * 4 + lecture_data.length + 3].textItem.size = 40;
                        }
                    }
                }
            }
            			`;
        // console.log(lectureData);
    };

    function compareTwoStrings(first, second) {
        first = first.replace(/\s+/g, '')
        second = second.replace(/\s+/g, '')

        if (!first.length && !second.length) return 1;                   // if both are empty strings
        if (!first.length || !second.length) return 0;                   // if only one is empty string
        if (first === second) return 1;       							 // identical
        if (first.length === 1 && second.length === 1) return 0;         // both are 1-letter strings
        if (first.length < 2 || second.length < 2) return 0;			 // if either is a 1-letter string

        let firstBigrams = new Map();
        for (let i = 0; i < first.length - 1; i++) {
            const bigram = first.substring(i, i + 2);
            const count = firstBigrams.has(bigram)
                ? firstBigrams.get(bigram) + 1
                : 1;

            firstBigrams.set(bigram, count);
        }
        ;

        let intersectionSize = 0;
        for (let i = 0; i < second.length - 1; i++) {
            const bigram = second.substring(i, i + 2);
            const count = firstBigrams.has(bigram)
                ? firstBigrams.get(bigram)
                : 0;

            if (count > 0) {
                firstBigrams.set(bigram, count - 1);
                intersectionSize++;
            }
        }

        return (2.0 * intersectionSize) / (first.length + second.length - 2);
    }

    function LCS(str1, str2) {
        var m = str1.length
        var n = str2.length
        var dp = [new Array(n + 1).fill(0)] //第一行全是0
        for (var i = 1; i <= m; i++) { //一共有m+1行
            dp[i] = [0] //第一列全是0
            for (var j = 1; j <= n; j++) {//一共有n+1列
                if (str1[i - 1] === str2[j - 1]) {
                    //注意这里，str1的第一个字符是在第二列中，因此要减1，str2同理
                    dp[i][j] = dp[i - 1][j - 1] + 1 //对角＋1
                } else {
                    dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1])
                }
            }
        }
        return m > n ? dp[m][n] * 100.0 / n : dp[m][n] * 100.0 / m;
    }

    function ConvertToCSV(objArray) {
        let array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
        let str = '';

        let line = '';
        for (let index in array[0]) {
            if (line != '') line += ','
            line += index;
        }

        str += line.replace('&nbsp;', ' ') + '\r\n';
        for (let i = 0; i < array.length; i++) {
            let line = '';
            for (let index in array[i]) {
                if (line != '') line += ','

                if (array[i][index].indexOf(',') > -1) {
                    line += '"' + array[i][index] + '"';
                } else {
                    line += array[i][index];
                }
            }

            str += line.replace('&nbsp;', ' ') + '\r\n';
        }

        return str;
    }

    function downloadString(text, fileType, fileName) {
        var blob = new Blob(["\uFEFF" + text], {type: fileType});

        var a = document.createElement('a');
        a.download = fileName;
        a.href = URL.createObjectURL(blob);
        a.dataset.downloadurl = [fileType, a.download, a.href].join(':');
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(function () {
            URL.revokeObjectURL(a.href);
        }, 1500);
    }

    function unique(arr) {
        console.log(arr.length);
        return Array.from(new Set(arr));
    }

    document.getElementById("btn2").onclick = function () {
        var rate = document.getElementById("ipt1").value;
        var content = document.getElementsByClassName("page")[0];
        var data = [];
        var nameList = unique(['品味《诗经》', '老子的智慧', '庄子新解', '汉书', '魏晋风度', '唐宋词史', '品味朱子', '红楼问梦', '“胡”说四大名著', '儒家养心课', '禅道智慧', '道德经', '古希腊哲学', '古典文明', '中世纪文明', '文艺复兴', '启蒙运动', '冷战', '世界当代史', '西方史学名著选读', '西方都市与文明', '世界主要宗教掠影', '美育与实践:书法的构形美学溯源', '美育与实践:茶道', '美育与实践:花艺', '美育与实践:黑白之道——围棋', '美育与实践:行为之美', '美育与实践:民乐', '美育与实践:古琴', '美育与实践:色彩美学', '音乐的观念', '音乐的观念（下）', '音乐的观念·音乐的多维视角', '跨界•对话', '周游列国：中国人开眼看世界', '城•人：多学科视野中的都市空间、历史与文化', '人文经典导读', '人文大讲堂', '人文大讲堂·中国文化巡礼', '人文大讲堂·周游列国', '人文大讲堂·艺术的观念', '人文大讲堂·性别与社会', '人文大讲堂·哲学与世界', '人文大讲堂·人文经典导读', '人文大讲堂·认识中国', '人文大讲堂·文艺鉴赏', '性别教育', '两岸国学与文化传承', '影像的世界', '媒体第一课', '与社会学同游', '生命科学导论', '“走进海洋”系列讲座', '生态之美', '一“诺”千金——诺贝尔文学奖作家经典作品导读', '海陆相望话丝路', '中外文化比较', '大学历史与文化', '智能制造与工业4.0', '数字媒体点亮生活', '西方古代建筑艺术史', '世界艺术博物馆之旅', '西方经典歌剧与音乐剧欣赏', '西方摇滚文化', '英国创造了现代世界吗? ——英国近代史', '知日之智——中日之间文化交涉的诠释与反思', '东山魁夷与日本艺术', '中东漫记', '全球化与中国史', '认识地球', '美国文化史', '中国古代城市史', '中国暨东方古代建筑艺术史', '文化中国', '官僚', '中国文学（先秦魏晋南北朝部分）', '中国文学（唐宋部分）', '中国科举文化', '大唐盛世：唐代的政治与社会', '明清小说中的社会生活', '灯谜中的中国智慧', '当代中国的文化生产', '中国经济与文化地理', '十二孔陶笛演奏', '男声合唱（上）', '小提琴演奏训练', '礼乐之邦的乐文化巡礼', '艺术欣赏与创作', '影像工作坊', '校园戏剧创作实践', '纪录片与实践', '基地实践与教学（上）', '迷人的音乐与即兴的乐趣', '聆听经典音乐', '美国大众流行音乐', '声乐艺术赏析', '性别与文学', '性别教育与生活', '身份与认同', '走近中医', '生活中的化学A', '磷与生活', '疾病与健康', '无知之知——哲学的智慧', '生活中的伦理', '物质文明', '家屋与族性', '文学与文化研究热点概念解析', '知识分子与公共领域', '公民常识', '科技伦理', '闽南方言与文化', '闽南话入门', '应用医疗人类学与身心健康', '文化人类学', '逻辑与科学', '推理与论证', '流行文化——爱与哀愁', '比较文学与文化', '跨界论道：科学走进人文', '国故新知：沟通文理，启迪智慧', '恋人絮语—世界电影的情感教育', '教育学电影批评', '思维规则', '沉舟帆影-海洋考古', '乡村仪式与戏剧', '乡村、乡愁与新乡村建设', '简明天文学', '药学与化妆品学', '文物鉴赏', '大数据时代的信息安全', '财税基础', '环境与能源', '航空航天基础', '电影产业及国际视野', '物理学与人类文明', '化学工业与社会', '美国社会与文化', '软件工程思想与方法', 'Positive Psychology（积极心理学）', '大自然探秘：自然与生态', '东西方文化巡礼', '人文与公共卫生', '华夏文明传播', '经济学经典', '美国文学经典', '品悟西游', '逻辑学', '社会心理学', '项目管理：案例与实践', '国剧赏析', '中国历史地理', '水与生活'].concat(["闽南话入门", "跨界•对话", "中国历史地理", "大唐盛世", "古典文明", "儒家养心课", "小提琴演奏训练", "国剧赏析", "生命科学导论", "生命科学导论", "生命科学导论", "生命科学导论", "大自然探秘", "道德经", "红楼问梦", "人文大讲堂•艺术的观念", "全球化与中国史", "世界主要宗教掠影", "中东漫记", "中东漫记", "小提琴训练与世界名曲欣赏", "中国暨东方古代建筑艺术史", "十二孔陶笛演奏", "公民常识", "人文大讲堂·中华文化巡礼", "人文大讲堂·人文经典导读", "中国文学（先秦魏晋南北朝部分）", "人文大讲堂·认识中国", "航空航天材料概论", "生态之美大讲堂", "华夏文明传播", "项目管理案例分析与实践", "东西方文化巡礼", "生命科学导论实验"]));
        console.log(nameList.length);
        var nameKey = '课程班级';
        // content.innerHTML += rate;
        csv({
            output: "json"
        })
            .fromString(content.innerText)
            .then(jsonObj => {
                // console.log(jsonObj);
                for (classData of jsonObj) {
                    className = classData[nameKey].split("-").slice(1).join().replace(/\([0-9]+\)$/i, '').trim();
                    for (tongshiName of nameList) {
                        if (LCS(className, tongshiName) >= rate) {
                            // console.log(LCS(className, tongshiName));
                            // console.log(className);
                            data.push(classData);
                        }
                    }

                }
                data = unique(data);
                // content.innerHTML = ConvertToCSV(data);
                downloadString(ConvertToCSV(data), "text/csv; charset=utf-8", "通识中心课程-" + rate + ".csv");
            });
    };
</script>
</body>
</html>
